package org.example;

import org.deeplearning4j.nn.conf.MultiLayerConfiguration;
import org.deeplearning4j.nn.conf.NeuralNetConfiguration;
import org.deeplearning4j.nn.conf.layers.DenseLayer;
import org.deeplearning4j.nn.conf.layers.OutputLayer;
import org.deeplearning4j.nn.multilayer.MultiLayerNetwork;
import org.nd4j.linalg.activations.Activation;
import org.nd4j.linalg.api.ndarray.INDArray;
import org.nd4j.linalg.factory.Nd4j;
import org.nd4j.linalg.learning.config.Adam;
import org.nd4j.linalg.lossfunctions.LossFunctions;
import org.json.JSONArray;
import org.json.JSONObject;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.HashMap;
import java.util.Map;
import java.util.Random;

public class ChatRLAgent {

    // DICCIONARIO de Preguntas -> Respuestas correctas (se carga desde JSON)
    private static final Map<String, String> RESPUESTAS_CORRECTAS = new HashMap<>();

    // UNA NEURONA POR LETRA (26 letras del alfabeto)
    private static final int ACTIONS = 15;
    private static final int STATE_SIZE = 26;
    private static final double GAMMA = 0.99;
    private static final double EPSILON_DECAY = 0.995;
    private static final double LEARNING_RATE = 0.001;

    private double epsilon = 1.0;
    private Random random = new Random();
    private MultiLayerNetwork model;
    private int totalAciertos = 0;
    private int totalIntentosEntrenamiento = 0;
    private Map<Integer, String> indiceARespuesta = new HashMap<>();
    private Map<String, Integer> respuestaAIndice = new HashMap<>();

    // Base de respuestas entrenadas
    private String[] respuestasBase = {
        "hola como estÃ¡s",
        "bien gracias",
        "estoy muy bien",
        "soy un chatbot",
        "claro te ayudarÃ©",
        "no entiendo",
        "puedo ayudarte",
        "quÃ© necesitas",
        "gracias por preguntar",
        "estoy aquÃ­ para ayudarte",
        "buenos dÃ­as que tal",
        "buenas noches descansa",
        "de nada para eso estoy",
        "adiÃ³s hasta luego",
        "me llamo chatbot"
    };

    public ChatRLAgent() {
        // Crear mapeos bidireccionales
        for (int i = 0; i < respuestasBase.length; i++) {
            indiceARespuesta.put(i, respuestasBase[i]);
            respuestaAIndice.put(respuestasBase[i], i);
        }

        // Red neuronal optimizada para 26 letras de entrada
        MultiLayerConfiguration config = new NeuralNetConfiguration.Builder()
                .updater(new Adam(LEARNING_RATE))
                .list()
                // Capa 1: 26 neuronas de entrada (una por letra) â†’ 128 neuronas
                .layer(new DenseLayer.Builder().nIn(STATE_SIZE).nOut(128)
                        .activation(Activation.RELU).build())
                // Capa 2: 128 neuronas â†’ 64 neuronas
                .layer(new DenseLayer.Builder().nOut(64)
                        .activation(Activation.RELU).build())
                // Capa 3: 64 neuronas â†’ 32 neuronas
                .layer(new DenseLayer.Builder().nOut(32)
                        .activation(Activation.RELU).build())
                // Capa de salida: 32 neuronas â†’ 15 respuestas (SOFTMAX para probabilidades)
                .layer(new OutputLayer.Builder(LossFunctions.LossFunction.MCXENT)
                        .activation(Activation.SOFTMAX)
                        .nOut(ACTIONS).build())
                .build();

        model = new MultiLayerNetwork(config);
        model.init();
    }

    /**
     * Carga las preguntas y respuestas desde un archivo JSON
     */
    public static void cargarDesdeJSON(String rutaArchivo) {
        try {
            String contenido = new String(Files.readAllBytes(Paths.get(rutaArchivo)));
            JSONArray jsonArray = new JSONArray(contenido);

            RESPUESTAS_CORRECTAS.clear();

            for (int i = 0; i < jsonArray.length(); i++) {
                JSONObject obj = jsonArray.getJSONObject(i);
                String pregunta = obj.getString("pregunta").toLowerCase();
                String respuesta = obj.getString("respuesta").toLowerCase();
                RESPUESTAS_CORRECTAS.put(pregunta, respuesta);
            }

            System.out.println("âœ… Se cargaron " + RESPUESTAS_CORRECTAS.size() + " pares pregunta-respuesta desde JSON\n");

        } catch (IOException e) {
            System.err.println("âŒ Error al leer el archivo JSON: " + e.getMessage());
            System.exit(1);
        }
    }

    /**
     * Convierte una pregunta a vector: UNA NEURONA POR LETRA
     */
    private double[] preguntaAVector(String pregunta) {
        double[] vector = new double[STATE_SIZE]; // 26 posiciones para a-z
        pregunta = pregunta.toLowerCase().replaceAll("[^a-z]", "");

        // Marca cada letra que aparece en la pregunta
        for (char c : pregunta.toCharArray()) {
            if (c >= 'a' && c <= 'z') {
                int indice = c - 'a';
                vector[indice] = 1.0; // Neurona activada (letra presente)
            }
        }

        return vector;
    }

    /**
     * Selecciona una respuesta basada en la pregunta
     */
    public String selectResponse(String pregunta) {
        if (random.nextDouble() < epsilon) {
            return respuestasBase[random.nextInt(respuestasBase.length)];
        }

        double[] preguntaVector = preguntaAVector(pregunta);
        INDArray input = Nd4j.create(new double[][]{preguntaVector});
        INDArray output = model.output(input);
        int respuestaIndex = Nd4j.argMax(output, 1).getInt(0);

        return indiceARespuesta.get(respuestaIndex);
    }

    /**
     * Calcula la recompensa comparando respuesta generada vs correcta
     */
    private double calcularRecompensa(String pregunta, String respuestaGenerada, String respuestaCorrecta) {
        respuestaGenerada = respuestaGenerada.toLowerCase();
        respuestaCorrecta = respuestaCorrecta.toLowerCase();

        // Coincidencia exacta
        if (respuestaGenerada.equals(respuestaCorrecta)) {
            return 10.0;
        }

        String[] palabrasGeneradas = respuestaGenerada.split(" ");
        String[] palabrasCorrectas = respuestaCorrecta.split(" ");

        int coincidencias = 0;
        for (String pGen : palabrasGeneradas) {
            for (String pCorr : palabrasCorrectas) {
                if (pGen.equals(pCorr)) {
                    coincidencias++;
                    break;
                }
            }
        }

        double recompensa = ((double) coincidencias / palabrasCorrectas.length) * 10;
        return Math.max(-1, recompensa);
    }

    /**
     * El agente aprende de la pregunta y la respuesta
     */
    public void learn(String pregunta, String respuestaGenerada, String respuestaCorrecta) {
        double[] preguntaVector = preguntaAVector(pregunta);
        INDArray input = Nd4j.create(new double[][]{preguntaVector});

        // Crear target one-hot: solo la respuesta correcta tiene valor 1.0
        double[] targetArray = new double[ACTIONS];
        Integer indiceCorrecta = respuestaAIndice.get(respuestaCorrecta);
        if (indiceCorrecta == null) {
            // Si no estÃ¡ en el mapeo, encontrar la mÃ¡s similar
            indiceCorrecta = 0;
        }
        targetArray[indiceCorrecta] = 1.0;

        INDArray target = Nd4j.create(new double[][]{targetArray});

        // Calcular recompensa
        double reward = calcularRecompensa(pregunta, respuestaGenerada, respuestaCorrecta);

        // Si la recompensa es buena, reforzar el aprendizaje
        if (reward > 5) {
            model.fit(input, target);
        } else {
            // Si es mala, aÃºn entrenar pero con menos peso
            model.fit(input, target);
        }

        epsilon *= EPSILON_DECAY;

        // Registrar si acertÃ³ para estadÃ­sticas
        if (reward > 5) {
            totalAciertos++;
        }
        totalIntentosEntrenamiento++;
    }

    public void disableExploration() {
        epsilon = 0.0;
    }

    public void resetEpsilon() {
        epsilon = 1.0;
    }

    public static void main(String[] args) {
        // Cargar preguntas desde JSON
        String rutaJSON = "preguntas.json";
        cargarDesdeJSON(rutaJSON);

        ChatRLAgent agent = new ChatRLAgent();

        System.out.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        System.out.println("â•‘   ğŸ“š CHATBOT CON RL - JSON CONFIG     â•‘");
        System.out.println("â•‘        POR LETRA (26 NEURONAS)        â•‘");
        System.out.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

        System.out.println("ğŸ§  Arquitectura de la red:");
        System.out.println("  Entrada: 26 neuronas (una por letra a-z)");
        System.out.println("  Capa 1:  128 neuronas (RELU)");
        System.out.println("  Capa 2:  64 neuronas (RELU)");
        System.out.println("  Capa 3:  32 neuronas (RELU)");
        System.out.println("  Salida:  15 neuronas (SOFTMAX + Cross-Entropy)\n");

        System.out.println("âš™ï¸ ParÃ¡metros:");
        System.out.println("  Learning Rate: " + ChatRLAgent.LEARNING_RATE);
        System.out.println("  Epsilon Decay: " + ChatRLAgent.EPSILON_DECAY);
        System.out.println("  Gamma: " + ChatRLAgent.GAMMA + "\n");

        // ========== ENTRENAMIENTO ==========
        System.out.println("ğŸ“š INICIANDO ENTRENAMIENTO...\n");

        int episodios = 500;

        for (int ep = 1; ep <= episodios; ep++) {
            double recompensaTotalEpisodio = 0;
            int intentosEpisodio = 0;

            for (Map.Entry<String, String> entry : RESPUESTAS_CORRECTAS.entrySet()) {
                String pregunta = entry.getKey();
                String respuestaCorrecta = entry.getValue();

                String respuestaGenerada = agent.selectResponse(pregunta);
                double recompensa = agent.calcularRecompensa(pregunta, respuestaGenerada, respuestaCorrecta);
                agent.learn(pregunta, respuestaGenerada, respuestaCorrecta);

                recompensaTotalEpisodio += recompensa;
                intentosEpisodio++;
            }

            // Mostrar progreso cada 20 episodios
            if (ep % 20 == 0) {
                double porcentajeAcierto = (agent.totalAciertos * 100.0) / agent.totalIntentosEntrenamiento;
                double recompensaPromedio = recompensaTotalEpisodio / intentosEpisodio;
                System.out.println("Episodio " + ep + "/" + episodios +
                                 " | PrecisiÃ³n: " + String.format("%.1f", porcentajeAcierto) + "% | " +
                                 "Recompensa: " + String.format("%.2f", recompensaPromedio) + "/10 | " +
                                 "Îµ: " + String.format("%.4f", agent.epsilon));
            }
        }

        System.out.println("\nâœ… Entrenamiento completado.\n");

        // ========== PRUEBA ==========
        System.out.println("ğŸ§ª PRUEBA DEL CHATBOT ENTRENADO\n");

        agent.disableExploration();

        System.out.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        System.out.println("â•‘     ğŸ¤– CHATBOT RL EN ACCIÃ“N ğŸ¤–        â•‘");
        System.out.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

        int aciertosFinales = 0;
        for (Map.Entry<String, String> entry : RESPUESTAS_CORRECTAS.entrySet()) {
            String pregunta = entry.getKey();
            String respuestaCorrecta = entry.getValue();
            String respuestaGenerada = agent.selectResponse(pregunta);

            double reward = agent.calcularRecompensa(pregunta, respuestaGenerada, respuestaCorrecta);
            String estado = (reward > 5) ? "âœ… CORRECTO" : "âŒ INCORRECTO";
            if (reward > 5) aciertosFinales++;

            System.out.println("Pregunta:          \"" + pregunta + "\"");
            System.out.println("Esperada:          \"" + respuestaCorrecta + "\"");
            System.out.println("Generada:          \"" + respuestaGenerada + "\"");
            System.out.println("PuntuaciÃ³n:        " + String.format("%.1f", reward) + "/10  " + estado);
            System.out.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
        }

        System.out.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        System.out.println("â•‘          ğŸ“Š RESULTADOS FINALES         â•‘");
        System.out.println("â•‘  Aciertos: " + aciertosFinales + "/" + RESPUESTAS_CORRECTAS.size() +
                         "  (" + String.format("%.1f", (aciertosFinales * 100.0) / RESPUESTAS_CORRECTAS.size()) + "%)");
        System.out.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

        // ========== PRUEBA CON PREGUNTAS NUEVAS NO ENTRENADAS ==========
        System.out.println("\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        System.out.println("â•‘  ğŸ”¬ PRUEBA CON PREGUNTAS NUEVAS        â•‘");
        System.out.println("â•‘     (NO ENTRENADAS - GENERALIZACIÃ“N)    â•‘");
        System.out.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

        String[] preguntasNuevas = {
            "hola amigo",
            "cÃ³mo te va",
            "quÃ© onda",
            "me ayudas",
            "cuÃ¡l es tu nombre",
            "hasta luego",
            "muchas gracias",
            "buenos tardes",
            "dime quiÃ©n eres",
            "hola quÃ© tal",
            "no entiendo",
            "en quÃ© puedo ayudarte",
            "feliz noche",
            "presenta",
            "te conozco"
        };

        System.out.println("Probando con preguntas nuevas no vistas durante el entrenamiento:\n");

        int aciertosNuevos = 0;
        int parcialidadNueva = 0;

        for (String pregunta : preguntasNuevas) {
            String respuestaGenerada = agent.selectResponse(pregunta);
            String respuestaMasCercana = encontrarRespuestaMasCercana(pregunta, agent);

            double reward = agent.calcularRecompensa(pregunta, respuestaGenerada, respuestaMasCercana);
            String estado = "";
            if (reward > 8) {
                estado = "âœ… MUY BUENO";
                aciertosNuevos++;
            } else if (reward > 5) {
                estado = "ğŸŸ¨ PARCIAL";
                parcialidadNueva++;
            } else if (reward > 2) {
                estado = "âš ï¸ DÃ‰BIL";
            } else {
                estado = "âŒ MALO";
            }

            System.out.println("Pregunta nueva:    \"" + pregunta + "\"");
            System.out.println("Esperada:          \"" + respuestaMasCercana + "\"");
            System.out.println("Respuesta:         \"" + respuestaGenerada + "\"");
            System.out.println("PuntuaciÃ³n:        " + String.format("%.1f", reward) + "/10  " + estado);
            System.out.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
        }

        System.out.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        System.out.println("â•‘      ğŸ“ˆ RESULTADOS GENERALIZACIÃ“N      â•‘");
        System.out.println("â•‘  Excelentes (>8):   " + aciertosNuevos + "/" + preguntasNuevas.length);
        System.out.println("â•‘  Parciales (5-8):   " + parcialidadNueva + "/" + preguntasNuevas.length);
        System.out.println("â•‘  Porcentaje Ã©xito:  " + String.format("%.1f", ((aciertosNuevos + parcialidadNueva) * 100.0) / preguntasNuevas.length) + "%");
        System.out.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    }

    /**
     * Encuentra la respuesta mÃ¡s similar a una pregunta nueva
     * basÃ¡ndose en las letras compartidas
     */
    private static String encontrarRespuestaMasCercana(String pregunta, ChatRLAgent agent) {
        String preguntaLower = pregunta.toLowerCase().replaceAll("[^a-z]", "");
        String mejorRespuesta = "no entiendo";
        int maxCoincidencias = 0;

        for (String preguntaEntrenada : RESPUESTAS_CORRECTAS.keySet()) {
            String preguntaEntrenadaLower = preguntaEntrenada.toLowerCase().replaceAll("[^a-z]", "");

            // Contar letras en comÃºn
            int coincidencias = 0;
            for (char c : preguntaLower.toCharArray()) {
                if (preguntaEntrenadaLower.indexOf(c) >= 0) {
                    coincidencias++;
                }
            }

            if (coincidencias > maxCoincidencias) {
                maxCoincidencias = coincidencias;
                mejorRespuesta = RESPUESTAS_CORRECTAS.get(preguntaEntrenada);
            }
        }

        return mejorRespuesta;
    }
}
